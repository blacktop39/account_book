generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String        @id @default(cuid())
  email               String        @unique
  name                String
  password            String?       // OAuth 사용자는 password 없음
  image               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  // 약관 동의
  termsAgreedAt       DateTime?     // 서비스 이용약관 동의 시각
  privacyAgreedAt     DateTime?     // 개인정보 처리방침 동의 시각
  marketingAgreed     Boolean       @default(false) // 마케팅 수신 동의
  marketingAgreedAt   DateTime?     // 마케팅 수신 동의 시각
  // 이메일 인증
  emailVerified       Boolean       @default(false) // 이메일 인증 여부
  emailVerifiedAt     DateTime?     // 이메일 인증 시각
  transactions Transaction[]
  resetTokens  ResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  categories   Category[]
  accounts     Account[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Transaction {
  id          String   @id @default(cuid())
  type        String   // "income" | "expense"
  amount      Int
  categoryId  String
  description String   @default("")
  place       String   @default("")
  date        String   // YYYY-MM-DD
  createdAt   DateTime @default(now())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model ResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  icon      String
  color     String
  type      String   // "income" | "expense"
  isDefault Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  // 서브카테고리 관계
  parentId  String?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Category[] @relation("CategoryHierarchy")

  @@unique([userId, name, type, parentId])
  @@index([userId, type])
  @@index([parentId])
}
